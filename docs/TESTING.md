# Руководство по тестированию SSH Tunnel System

## Обзор

SSH Tunnel System имеет комплексную систему тестирования, включающую:
- Модульные тесты (Unit Tests)
- Интеграционные тесты (Integration Tests)
- Тесты производительности (Benchmarks)
- Тесты надежности (Reliability Tests)
- Автоматизированное тестирование через CI/CD

## Запуск тестов

### Быстрый старт

```bash
# Запуск всех тестов
make test

# Запуск тестов с подробным выводом
make test-verbose

# Запуск тестов с покрытием кода
make test-cover
```

### Специфичные тесты

```bash
# Тестирование SSH сервера
make test-server

# Тестирование аутентификации
make test-auth

# Тестирование портов
make test-ports

# Тестирование туннелей
make test-tunnels

# Тестирование надежности
make test-reliability

# Тестирование производительности
make test-performance
```

### Benchmarks

```bash
# Запуск всех бенчмарков
make bench

# Детальные бенчмарки туннелей
make bench-tunnel

# Профилирование CPU
make profile-cpu

# Профилирование памяти
make profile-mem
```

## Структура тестов

### Модульные тесты (`pkg/tunnel/server_test.go`)

#### `TestServerCreation`
- Тестирует создание SSH сервера
- Проверяет инициализацию компонентов
- Валидирует конфигурацию

#### `TestServerStartStop`
- Тестирует запуск и остановку сервера
- Проверяет освобождение ресурсов
- Валидирует состояние сокетов

#### `TestSSHAuthentication`
- Тестирует успешную аутентификацию
- Проверяет загрузку SSH ключей
- Валидирует права доступа

#### `TestSSHAuthenticationFailure`
- Тестирует неудачную аутентификацию
- Проверяет отказ неавторизованным ключам
- Валидирует безопасность

#### `TestPortAllocation`
- Тестирует выделение портов
- Проверяет освобождение портов
- Валидирует управление пулом портов

#### `TestReverseTunnel`
- Тестирует создание обратного туннеля
- Проверяет передачу данных через туннель
- Валидирует HTTP туннелирование

#### `TestMultipleClients`
- Тестирует подключение нескольких клиентов
- Проверяет изоляцию клиентов
- Валидирует статистику сервера

#### `TestPortExhaustion`
- Тестирует исчерпание портов
- Проверяет обработку ошибок
- Валидирует восстановление после освобождения

### Интеграционные тесты (`pkg/tunnel/server_bench_test.go`)

#### `TestTunnelReliability`
- Тестирует надежность туннелей под нагрузкой
- Множественные одновременные соединения
- Проверка целостности данных

#### `TestServerRecovery`
- Тестирует восстановление после сбоев
- Быстрые подключения/отключения
- Исчерпание ресурсов

#### `TestLargeDataTransfer`
- Тестирует передачу больших объемов данных (1MB+)
- Измеряет пропускную способность
- Проверяет целостность данных

#### `TestTunnelTimeout`
- Тестирует поведение при таймаутах
- Обработка медленных соединений
- Валидация timeout ошибок

#### `TestClientReconnection`
- Тестирует переподключение клиентов
- Проверяет очистку ресурсов
- Валидирует состояние сервера

### Benchmarks

#### `BenchmarkServerCreation`
- Измеряет время создания сервера
- Проверяет утечки памяти
- Оптимизация инициализации

#### `BenchmarkPortAllocation`
- Измеряет производительность пула портов
- Проверяет блокировки
- Оптимизация конкурентного доступа

#### `BenchmarkSSHConnections`
- Измеряет время установки SSH соединений
- Проверяет производительность аутентификации
- Оптимизация handshake

#### `BenchmarkReverseTunnelThroughput`
- Измеряет пропускную способность туннелей
- Проверяет задержки
- Оптимизация передачи данных

#### `BenchmarkConcurrentClients`
- Измеряет производительность при множественных клиентах
- Проверяет масштабируемость
- Оптимизация конкурентности

## Тестовая инфраструктура

### TestServer Helper

```go
type TestServer struct {
    server     *Server
    config     *config.ServerConfig
    clientKeys []ssh.Signer
    tempDir    string
}
```

Предоставляет:
- Автоматическое создание временных файлов
- Генерацию SSH ключей для тестов
- Упрощенное создание клиентских соединений
- Автоматическую очистку ресурсов

### TestHTTPServer Helper

Простой HTTP сервер для тестирования туннелирования:
- Echo сервер для проверки данных
- Настраиваемые ответы
- Метрики производительности

## Требования к тестовой среде

### Минимальные требования
- Go 1.21+
- Доступные порты 12000-12099 (для тестов)
- Права на создание временных файлов
- Доступ к loopback интерфейсу (127.0.0.1)

### Рекомендуемые требования
- 4GB+ RAM (для больших тестов)
- SSD диск (для быстрых I/O тестов)
- Многоядерный процессор (для конкурентных тестов)

## Интерпретация результатов

### Успешные тесты
```
PASS: TestServerCreation
PASS: TestReverseTunnel
PASS: TestTunnelReliability
```

### Benchmark результаты
```
BenchmarkReverseTunnelThroughput-8    1000    1234567 ns/op    1024 B/op    2 allocs/op
```

Означает:
- 1000 итераций
- 1.2ms на операцию
- 1KB выделено за операцию
- 2 аллокации за операцию

### Покрытие кода
```
coverage: 85.4% of statements
```

Целевое покрытие: 80%+

## Отладка тестов

### Увеличение детализации логов

```bash
# Запуск с debug логами
go test -v -run TestReverseTunnel ./pkg/tunnel/
```

### Профилирование проблемных тестов

```bash
# CPU профиль
go test -cpuprofile=cpu.prof -run TestLargeDataTransfer ./pkg/tunnel/
go tool pprof cpu.prof

# Memory профиль
go test -memprofile=mem.prof -run TestLargeDataTransfer ./pkg/tunnel/
go tool pprof mem.prof
```

### Анализ race conditions

```bash
# Запуск с детектором гонок
go test -race -v ./pkg/tunnel/
```

## Известные ограничения

### Платформо-зависимые тесты
- Тесты используют loopback интерфейс
- Требуют доступ к файловой системе
- Зависят от доступности портов

### Временные ограничения
- Некоторые тесты могут занимать до 10 секунд
- Benchmark тесты могут быть медленными на слабом железе
- Таймауты могут срабатывать на загруженных системах

## Добавление новых тестов

### Шаблон модульного теста

```go
func TestNewFeature(t *testing.T) {
    ts := setupTestServer(t)
    defer ts.cleanup()

    ts.startServer(t)

    // Тест логика здесь
    
    if result != expected {
        t.Errorf("Expected %v, got %v", expected, result)
    }
}
```

### Шаблон benchmark теста

```go
func BenchmarkNewFeature(b *testing.B) {
    ts := setupTestServer(&testing.T{})
    defer ts.cleanup()

    b.ResetTimer()
    for i := 0; i < b.N; i++ {
        // Benchmark логика здесь
    }
}
```

## CI/CD Integration

### GitHub Actions
Автоматические тесты запускаются на:
- Push в main/develop ветки
- Pull Request
- Создание тегов

### Этапы CI
1. **Test** - модульные тесты на Go 1.21/1.22
2. **Build** - сборка для всех платформ
3. **Integration Test** - интеграционные тесты
4. **Security Scan** - сканирование безопасности
5. **Lint** - проверка качества кода
6. **Docker** - сборка Docker образов
7. **Release** - создание релизов для тегов

### Требования для merge
- ✅ Все тесты проходят
- ✅ Покрытие кода >80%
- ✅ Нет предупреждений линтера
- ✅ Безопасность проверена
- ✅ Код отформатирован

## Лучшие практики

### При написании тестов
1. Используйте описательные имена тестов
2. Тестируйте как success, так и failure случаи
3. Проверяйте граничные условия
4. Очищайте ресурсы после тестов
5. Избегайте зависимостей между тестами

### При отладке
1. Запускайте конкретные тесты с `-v`
2. Используйте race detector
3. Проверяйте утечки ресурсов
4. Анализируйте производительность
5. Тестируйте на разных платформах

### При добавлении функций
1. Пишите тесты до реализации (TDD)
2. Добавляйте benchmarks для критических путей
3. Тестируйте интеграцию с существующим кодом
4. Обновляйте документацию
5. Проверяйте обратную совместимость
