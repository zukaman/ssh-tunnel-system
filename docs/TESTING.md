# Руководство по тестированию SSH Tunnel System

## Обзор

SSH Tunnel System включает comprehensive набор тестов для обеспечения стабильности и корректности работы как серверной, так и клиентской части системы.

## Структура тестов

### Server Tests (`pkg/tunnel/server_test.go`)
- **TestServerCreation** - Тестирование создания сервера и инициализации
- **TestServerStartStop** - Тестирование запуска и остановки сервера
- **TestSSHAuthentication** - Тестирование SSH аутентификации
- **TestSSHAuthenticationFailure** - Тестирование отказа в аутентификации
- **TestPortAllocation** - Тестирование выделения и освобождения портов
- **TestReverseTunnel** - Тестирование обратных туннелей
- **TestMultipleClients** - Тестирование множественных клиентов
- **TestPortExhaustion** - Тестирование исчерпания пула портов

### Client Tests (`pkg/tunnel/client_test.go`)
- **TestClientCreation** - Тестирование создания клиента
- **TestClientStartStop** - Тестирование запуска и остановки клиента
- **TestClientWithRealServer** - Интеграционное тестирование клиент-сервер
- **TestClientReconnection** - Тестирование переподключения клиента
- **TestClientTunnelDataFlow** - Тестирование потока данных через туннели
- **TestClientMultipleTunnels** - Тестирование множественных туннелей
- **TestClientErrorHandling** - Тестирование обработки ошибок

### Benchmark Tests (`pkg/tunnel/server_bench_test.go`)
- Производительностные тесты для серверных компонентов

## Запуск тестов

### Все тесты
```bash
make test
```

### Тесты с подробным выводом
```bash
make test-verbose
```

### Быстрые тесты (только компиляция + базовые проверки)
```bash
make quick-test
```

### Конкретные группы тестов
```bash
# Только server тесты
make test-server

# Только client тесты  
make test-client

# Только тесты туннелей
make test-tunnels

# Тесты производительности
make bench
```

### Тесты с покрытием
```bash
make test-cover
```

### Специфичные тесты
```bash
# Тестирование аутентификации
make test-auth

# Тестирование портов
make test-ports

# Тестирование надежности
make test-reliability

# Интеграционные тесты
make test-integration
```

## Особенности реализации тестов

### Временные файлы и очистка
- Все тесты используют временные директории для SSH ключей и конфигурации
- Автоматическая очистка ресурсов после завершения тестов
- Изолированность тестов друг от друга

### SSH ключи для тестирования
- Генерация RSA ключей для тестирования (2048 бит)
- Создание файла authorized_keys для каждого теста
- Поддержка множественных ключей для тестирования разных клиентов

### Синхронизация и таймауты
- Правильные таймауты для предотвращения зависания тестов
- Использование каналов для синхронизации горутин
- Обработка race conditions через мьютексы

### Тестовые HTTP серверы
- Простые HTTP серверы для тестирования туннелирования
- Автоматическое выделение портов для избежания конфликтов
- Корректное закрытие ресурсов

## Исправленные проблемы

### Основные исправления (v2.2)
1. **Функция contains()**: Заменена неэффективная рекурсивная реализация на `strings.Contains()`
2. **Race conditions**: Добавлена правильная синхронизация через мьютексы
3. **Таймауты**: Улучшены таймауты для стабильности тестов
4. **Переменная http**: Переименована в `healthServer` для избежания конфликтов
5. **Обработка ошибок**: Улучшена обработка ошибок в клиентских тестах

### До исправлений (проблемы)
```go
// Плохо: неэффективная рекурсивная функция
func contains(s, substr string) bool {
    return len(s) >= len(substr) && 
           (s == substr || 
            contains(s[1:], substr) || 
            (len(s) > 0 && s[:len(substr)] == substr))
}

// Плохо: конфликт имен
http := &HTTPHealthServer{...}
```

### После исправлений
```go
// Хорошо: использование стандартной библиотеки
if !strings.Contains(response, "HTTP/1.1 200 OK") {
    t.Errorf("Expected HTTP 200 OK response, got: %s", response)
}

// Хорошо: понятные имена переменных
healthServer := &HTTPHealthServer{...}
```

## Тестовые сценарии

### Интеграционные тесты
1. **Подключение клиента к серверу**
   - Запуск тестового сервера
   - Создание клиента с правильными ключами
   - Проверка успешного подключения

2. **Установка туннелей**
   - Создание локального HTTP сервера
   - Установка reverse tunnel через SSH
   - Проверка прохождения HTTP трафика

3. **Множественные клиенты**
   - Подключение нескольких клиентов одновременно
   - Проверка изоляции туннелей
   - Корректное отключение клиентов

### Тесты надежности
1. **Переподключение при сбоях**
   - Остановка сервера во время подключения
   - Перезапуск сервера
   - Автоматическое переподключение клиента

2. **Исчерпание ресурсов**
   - Исчерпание пула портов
   - Корректная обработка ошибок
   - Освобождение ресурсов

## Debugging тестов

### Включение debug логов
```bash
# Запуск с debug логами
LOGLEVEL=debug make test-verbose
```

### Запуск отдельного теста
```bash
# Запуск конкретного теста
go test -v -run TestServerCreation ./pkg/tunnel/

# Запуск теста с таймаутом
go test -v -timeout 30s -run TestReverseTunnel ./pkg/tunnel/
```

### Профилирование
```bash
# CPU профилирование
make profile-cpu

# Memory профилирование  
make profile-mem
```

## Continuous Integration

### GitHub Actions
Тесты автоматически запускаются при:
- Push в main branch
- Создании Pull Request
- Изменении файлов в `pkg/` директории

### Локальная проверка перед коммитом
```bash
# Полная проверка качества
make ci

# Быстрая проверка
make quality
```

## Покрытие кода

### Генерация отчета
```bash
make test-cover
```

### Просмотр HTML отчета
```bash
# Откроется coverage.html в браузере
open coverage.html
```

### Целевые показатели
- **Server package**: >80% покрытие
- **Client package**: >75% покрытие
- **Config package**: >90% покрытие

## Лучшие практики

### Написание новых тестов
1. **Изоляция**: Каждый тест должен быть независимым
2. **Очистка**: Всегда освобождайте ресурсы в defer блоках
3. **Таймауты**: Используйте разумные таймауты для предотвращения зависания
4. **Именование**: Используйте описательные имена тестов

### Пример хорошего теста
```go
func TestNewFeature(t *testing.T) {
    // Setup
    ts := setupTestServer(t)
    defer ts.cleanup()
    
    // Test execution
    result, err := ts.server.NewFeature()
    
    // Assertions
    if err != nil {
        t.Fatalf("Unexpected error: %v", err)
    }
    
    if result != expected {
        t.Errorf("Expected %v, got %v", expected, result)
    }
}
```

## Troubleshooting

### Частые проблемы
1. **Port already in use**: Используйте динамическое выделение портов (port 0)
2. **Race conditions**: Добавьте правильную синхронизацию
3. **Timeout errors**: Увеличьте таймауты для медленных систем
4. **SSH key errors**: Проверьте генерацию и права доступа к ключам

### Решения
```go
// Динамическое выделение портов
listener, err := net.Listen("tcp", "127.0.0.1:0")
port := listener.Addr().(*net.TCPAddr).Port

// Правильная синхронизация
var wg sync.WaitGroup
wg.Add(1)
go func() {
    defer wg.Done()
    // work
}()
wg.Wait()
```

## Заключение

Система тестирования SSH Tunnel System обеспечивает высокое качество и надежность кода. Все основные проблемы исправлены в версии 2.2, и тесты теперь стабильно проходят на различных платформах.

Для вопросов по тестированию обращайтесь к документации или создавайте issues в репозитории проекта.
